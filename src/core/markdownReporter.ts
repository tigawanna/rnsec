import type { Finding, ScanResult } from '../types/findings.js';
import { compareScans, generateComparisonSummary, type ScanComparison } from '../utils/scanComparison.js';

export interface MarkdownReportOptions {
  previousFindings?: Finding[];
  includeComparison?: boolean;
}

export class MarkdownReporter {
  private readonly COMMENT_IDENTIFIER = '<!-- rnsec-security-report -->';
  
  /**
   * Generate markdown report for GitHub PR comments
   */
  generateReport(result: ScanResult, options?: MarkdownReportOptions): string {
    const { findings, scannedFiles, duration, timestamp } = result;
    
    let report = this.COMMENT_IDENTIFIER + '\n';
    
    // Add comparison if previous findings are provided
    let comparison: ScanComparison | undefined;
    if (options?.previousFindings && options.includeComparison) {
      comparison = compareScans(findings, options.previousFindings);
    }
    
    if (findings.length === 0) {
      report += this.generateSuccessReport(result, comparison);
    } else {
      report += this.generateVulnerabilityReport(result, comparison);
    }
    
    return report;
  }
  
  /**
   * Get the comment identifier for finding existing comments
   */
  getCommentIdentifier(): string {
    return this.COMMENT_IDENTIFIER;
  }

  private generateSuccessReport(result: ScanResult, comparison?: ScanComparison): string {
    const { scannedFiles, duration } = result;
    
    let report = `## ğŸ”’ Security Scan Results

âœ… **No security vulnerabilities detected**

Your React Native app passed all security checks!

### ğŸ“Š Scan Summary
| Metric | Value |
|--------|-------|
| ğŸ”´ High Severity | 0 |
| ğŸŸ¡ Medium Severity | 0 |
| ğŸ”µ Low Severity | 0 |
| ğŸ“ Files Scanned | ${scannedFiles || 'N/A'} |
| âš¡ Duration | ${(duration / 1000).toFixed(2)}s |
| ğŸ• Completed | ${result.timestamp.toLocaleString()} |

### ğŸ‰ Risk Level: SECURE
Great job! No security vulnerabilities detected.

---

*Generated by [rnsec](https://github.com/adnxy/rnsec) - React Native Security Scanner*`;
    
    // Add comparison summary if available
    if (comparison) {
      report += '\n\n' + generateComparisonSummary(comparison);
    }
    
    return report;
  }

  private generateVulnerabilityReport(result: ScanResult, comparison?: ScanComparison): string {
    const { findings, scannedFiles, duration, timestamp } = result;
    
    const high = findings.filter(f => f.severity === 'HIGH').length;
    const medium = findings.filter(f => f.severity === 'MEDIUM').length;
    const low = findings.filter(f => f.severity === 'LOW').length;
    
    const riskLevel = high >= 3 ? 'ğŸš¨ CRITICAL' 
      : high >= 1 ? 'âš ï¸ HIGH' 
      : medium >= 3 ? 'âš ï¸ MODERATE'
      : medium >= 1 ? 'â„¹ï¸ LOW'
      : 'â„¹ï¸ MINOR';

    let markdown = `## ğŸ”’ Security Scan Results

${riskLevel} **${findings.length} security ${findings.length === 1 ? 'issue' : 'issues'} found**

### ğŸ“Š Issue Summary
| Severity | Count | Status |
|----------|-------|--------|
| ğŸ”´ High | ${high} | ${high > 0 ? 'âŒ Needs attention' : 'âœ… None'} |
| ğŸŸ¡ Medium | ${medium} | ${medium > 0 ? 'âš ï¸ Review recommended' : 'âœ… None'} |
| ğŸ”µ Low | ${low} | ${low > 0 ? 'â„¹ï¸ Address when possible' : 'âœ… None'} |

### ğŸ“ˆ Scan Performance
| Metric | Value |
|--------|-------|
| ğŸ“ Files Scanned | ${scannedFiles || 'N/A'} |
| âš¡ Duration | ${(duration / 1000).toFixed(2)}s |
| ğŸ• Completed | ${result.timestamp.toLocaleString()} |

`;

    // Add comparison summary if available
    if (comparison) {
      markdown += generateComparisonSummary(comparison);
    }

    // Group findings by severity
    const grouped = this.groupBySeverity(findings);
    
    if (grouped.HIGH.length > 0) {
      markdown += this.generateSeveritySection('ğŸ”´ High Severity', grouped.HIGH);
    }
    
    if (grouped.MEDIUM.length > 0) {
      markdown += this.generateSeveritySection('ğŸŸ¡ Medium Severity', grouped.MEDIUM);
    }
    
    if (grouped.LOW.length > 0) {
      markdown += this.generateSeveritySection('ğŸ”µ Low Severity', grouped.LOW);
    }

    markdown += `---

### ğŸ¯ Risk Assessment
${this.generateRiskAssessment(high, medium, low)}

---

*Generated by [rnsec](https://github.com/adnxy/rnsec) - React Native Security Scanner*`;

    return markdown;
  }

  private generateSeveritySection(title: string, findings: Finding[]): string {
    let section = `\n### ${title}\n\n`;
    
    // Add collapsible section for better organization
    section += `<details>\n<summary>Click to expand ${findings.length} ${findings.length === 1 ? 'issue' : 'issues'}</summary>\n\n`;
    
    findings.forEach((finding, index) => {
      const icon = finding.severity === 'HIGH' ? 'ğŸ”´' : 
                   finding.severity === 'MEDIUM' ? 'ğŸŸ¡' : 'ğŸ”µ';
      
      const location = finding.filePath ? `\`${this.formatFilePath(finding.filePath)}${finding.line ? `:${finding.line}` : ''}\`` : '';
      const debugBadge = finding.isDebugContext ? ' ğŸ› [DEBUG]' : '';
      
      section += `${index + 1}. **${icon} ${finding.description || finding.ruleId}**${debugBadge}\n`;
      if (location) {
        section += `   ğŸ“ ${location}\n`;
      }
      if (finding.suggestion) {
        section += `   ğŸ’¡ **Suggestion:** ${finding.suggestion}\n`;
      }
      
      // Add code snippet if available
      if (finding.snippet) {
        section += `   \n   **Code:**\n   \`\`\`typescript\n   ${finding.snippet}\n   \`\`\`\n`;
      }
      
      section += '\n';
    });
    
    section += `</details>\n`;
    
    return section;
  }

  private generateRiskAssessment(high: number, medium: number, low: number): string {
    if (high >= 3) {
      return 'ğŸš¨ **CRITICAL RISK** - Multiple high-severity vulnerabilities detected. Immediate action required before merging.';
    } else if (high >= 1) {
      return 'âš ï¸ **HIGH RISK** - High-severity vulnerabilities detected. Address before merging if possible.';
    } else if (medium >= 3) {
      return 'âš ï¸ **MODERATE RISK** - Multiple medium-severity issues. Review and address before merging.';
    } else if (medium >= 1) {
      return 'â„¹ï¸ **LOW RISK** - Some medium-severity issues. Address as part of this PR or follow-up.';
    } else if (low >= 1) {
      return 'â„¹ï¸ **MINOR RISK** - Low-severity issues detected. Can be addressed in future iterations.';
    }
    return 'âœ… **SECURE** - No significant security issues detected.';
  }

  private groupBySeverity(findings: Finding[]): Record<string, Finding[]> {
    return findings.reduce(
      (acc, finding) => {
        acc[finding.severity].push(finding);
        return acc;
      },
      {
        HIGH: [] as Finding[],
        MEDIUM: [] as Finding[],
        LOW: [] as Finding[],
      }
    );
  }

  private formatFilePath(filePath: string): string {
    const parts = filePath.split('/');
    if (parts.length > 3) {
      return '.../' + parts.slice(-3).join('/');
    }
    return filePath;
  }
}
