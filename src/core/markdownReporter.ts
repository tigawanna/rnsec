import type { Finding, ScanResult } from '../types/findings.js';

export class MarkdownReporter {
  /**
   * Generate markdown report for GitHub PR comments
   */
  generateReport(result: ScanResult): string {
    const { findings, scannedFiles, duration, timestamp } = result;
    
    if (findings.length === 0) {
      return this.generateSuccessReport(result);
    }
    
    return this.generateVulnerabilityReport(result);
  }

  private generateSuccessReport(result: ScanResult): string {
    const { scannedFiles, duration } = result;
    
    return `## üîí Security Scan Results

‚úÖ **No security vulnerabilities detected**

Your React Native app passed all security checks!

### üìä Scan Summary
| Metric | Value |
|--------|-------|
| üî¥ High Severity | 0 |
| üü° Medium Severity | 0 |
| üîµ Low Severity | 0 |
| üìÅ Files Scanned | ${scannedFiles || 'N/A'} |
| ‚ö° Duration | ${(duration / 1000).toFixed(2)}s |
| üïê Completed | ${result.timestamp.toLocaleString()} |

### üéâ Risk Level: SECURE
Great job! No security vulnerabilities detected.

---

*Generated by [rnsec](https://github.com/adnxy/rnsec) - React Native Security Scanner*`;
  }

  private generateVulnerabilityReport(result: ScanResult): string {
    const { findings, scannedFiles, duration, timestamp } = result;
    
    const high = findings.filter(f => f.severity === 'HIGH').length;
    const medium = findings.filter(f => f.severity === 'MEDIUM').length;
    const low = findings.filter(f => f.severity === 'LOW').length;
    
    const riskLevel = high >= 3 ? 'üö® CRITICAL' 
      : high >= 1 ? '‚ö†Ô∏è HIGH' 
      : medium >= 3 ? '‚ö†Ô∏è MODERATE'
      : medium >= 1 ? '‚ÑπÔ∏è LOW'
      : '‚ÑπÔ∏è MINOR';

    let markdown = `## üîí Security Scan Results

${riskLevel} **${findings.length} security ${findings.length === 1 ? 'issue' : 'issues'} found**

### üìä Issue Summary
| Severity | Count | Status |
|----------|-------|--------|
| üî¥ High | ${high} | ${high > 0 ? '‚ùå Needs attention' : '‚úÖ None'} |
| üü° Medium | ${medium} | ${medium > 0 ? '‚ö†Ô∏è Review recommended' : '‚úÖ None'} |
| üîµ Low | ${low} | ${low > 0 ? '‚ÑπÔ∏è Address when possible' : '‚úÖ None'} |

### üìà Scan Performance
| Metric | Value |
|--------|-------|
| üìÅ Files Scanned | ${scannedFiles || 'N/A'} |
| ‚ö° Duration | ${(duration / 1000).toFixed(2)}s |
| üïê Completed | ${result.timestamp.toLocaleString()} |

`;

    // Group findings by severity
    const grouped = this.groupBySeverity(findings);
    
    if (grouped.HIGH.length > 0) {
      markdown += this.generateSeveritySection('üî¥ High Severity', grouped.HIGH);
    }
    
    if (grouped.MEDIUM.length > 0) {
      markdown += this.generateSeveritySection('üü° Medium Severity', grouped.MEDIUM);
    }
    
    if (grouped.LOW.length > 0) {
      markdown += this.generateSeveritySection('üîµ Low Severity', grouped.LOW);
    }

    markdown += `---

### üéØ Risk Assessment
${this.generateRiskAssessment(high, medium, low)}

---

*Generated by [rnsec](https://github.com/adnxy/rnsec) - React Native Security Scanner*`;

    return markdown;
  }

  private generateSeveritySection(title: string, findings: Finding[]): string {
    let section = `\n### ${title}\n\n`;
    
    findings.forEach((finding, index) => {
      const icon = finding.severity === 'HIGH' ? 'üî¥' : 
                   finding.severity === 'MEDIUM' ? 'üü°' : 'üîµ';
      
      const location = finding.filePath ? `\`${this.formatFilePath(finding.filePath)}${finding.line ? `:${finding.line}` : ''}\`` : '';
      const debugBadge = finding.isDebugContext ? ' üêõ [DEBUG]' : '';
      
      section += `${index + 1}. **${icon} ${finding.description || finding.ruleId}**${debugBadge}\n`;
      if (location) {
        section += `   üìç ${location}\n`;
      }
      if (finding.suggestion) {
        section += `   üí° **Suggestion:** ${finding.suggestion}\n`;
      }
      section += '\n';
    });
    
    return section;
  }

  private generateRiskAssessment(high: number, medium: number, low: number): string {
    if (high >= 3) {
      return 'üö® **CRITICAL RISK** - Multiple high-severity vulnerabilities detected. Immediate action required before merging.';
    } else if (high >= 1) {
      return '‚ö†Ô∏è **HIGH RISK** - High-severity vulnerabilities detected. Address before merging if possible.';
    } else if (medium >= 3) {
      return '‚ö†Ô∏è **MODERATE RISK** - Multiple medium-severity issues. Review and address before merging.';
    } else if (medium >= 1) {
      return '‚ÑπÔ∏è **LOW RISK** - Some medium-severity issues. Address as part of this PR or follow-up.';
    } else if (low >= 1) {
      return '‚ÑπÔ∏è **MINOR RISK** - Low-severity issues detected. Can be addressed in future iterations.';
    }
    return '‚úÖ **SECURE** - No significant security issues detected.';
  }

  private groupBySeverity(findings: Finding[]): Record<string, Finding[]> {
    return findings.reduce(
      (acc, finding) => {
        acc[finding.severity].push(finding);
        return acc;
      },
      {
        HIGH: [] as Finding[],
        MEDIUM: [] as Finding[],
        LOW: [] as Finding[],
      }
    );
  }

  private formatFilePath(filePath: string): string {
    const parts = filePath.split('/');
    if (parts.length > 3) {
      return '.../' + parts.slice(-3).join('/');
    }
    return filePath;
  }
}
